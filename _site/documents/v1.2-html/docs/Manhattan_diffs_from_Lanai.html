

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>DART Manhattan Differences from Lanai Release Notes &mdash; DART 2.0.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> DART
          

          
          </a>

          
            
            
              <div class="version">
                2.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="Lanai_diffs_from_Kodiak.html">DART Lanai Differences from Kodiak Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="auto-doc.html">Fortran</a></li>
<li class="toctree-l1"><a class="reference internal" href="Process.html">Conversion process</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">DART</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>DART Manhattan Differences from Lanai Release Notes</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/docs/Manhattan_diffs_from_Lanai.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="dart-manhattan-differences-from-lanai-release-notes">
<h1>DART Manhattan Differences from Lanai Release Notes<a class="headerlink" href="#dart-manhattan-differences-from-lanai-release-notes" title="Permalink to this headline">¶</a></h1>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>&nbsp;</td>
<td><div class="first last line-block">
<div class="line">Jump to <a class="reference external" href="../index.html">DART Documentation Main
Index</a></div>
<div class="line">version information for this file:</div>
<div class="line">$Id:
Manhattan_diffs_from_Lanai.html
11243 2017-03-08 21:35:09Z
<a class="reference external" href="mailto:nancy&#37;&#52;&#48;ucar&#46;edu">nancy<span>&#64;</span>ucar<span>&#46;</span>edu</a> $</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><a class="reference external" href="#Overview">Overview</a> / <a class="reference external" href="#NetcdfRestarts">NetCDF Restart Files</a> /
<a class="reference external" href="#ForwardOps">Forward Operators</a> / <a class="reference external" href="#ObsConvert">Vertical
Conversion</a> / <a class="reference external" href="#Diagnostics">DART Diagnostics
Changes</a> / <a class="reference external" href="#ModelMod">model_mod.f90 Interface
Changes</a> / <a class="reference external" href="#ObsQuantity">Observation Quantities</a> /
<a class="reference external" href="#NameListChanges">Additions/Changes to Existing Namelists</a> /
<a class="reference external" href="#Perturbations">Perturbations</a> / <a class="reference external" href="#Legalese">Terms of Use</a></p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This document includes an overview of the changes in the DART system
since the Lanai release. For further details on any of these items look
at the HTML documentation for that specific part of the system.</p>
<p>The two most significant changes in the Manhattan version of DART are it
can support running models with a state vector larger than the memory of
a single task, removing a limit from the Lanai version of DART. It also
reads and writes NetCDF files directly instead of requiring a conversion
from one file to another. There are many other smaller changes, detailed
below.</p>
<p>Manhattan supported models:</p>
<ul class="simple">
<li>9var</li>
<li>bgrid_solo</li>
<li>cam-fv</li>
<li>cice</li>
<li>clm</li>
<li>cm1</li>
<li>forced_lorenz_96</li>
<li>ikeda</li>
<li>lorenz_63</li>
<li>lorenz_84</li>
<li>lorenz_96</li>
<li>lorenz_96_2scale</li>
<li>lorenz_04</li>
<li>mpas_atm (NetCDF overwrite not supported for
update_u_from_reconstruct = .true. )</li>
<li>null_model</li>
<li>POP</li>
<li>ROMS</li>
<li>simple_advection</li>
<li>wrf</li>
</ul>
<p>If your model of interest is not on the list consider checking out the
&#8216;Classic&#8217; release of DART, which is Lanai plus bug fixes and minor
enhancements. All models previously supported by Lanai are still in DART
&#8216;Classic&#8217;.</p>
<p>These are the major differences between the Lanai/Classic and Manhattan
releases of DART:</p>
<ul class="simple">
<li>Read and write NetCDF restarts</li>
<li>Calculation of forward operators</li>
<li>Vertical conversion of observation locations</li>
<li>Diagnostic file changes</li>
<li><a class="reference external" href="state_structure.html">State structure module</a></li>
<li>model_mod interface changes</li>
<li>Observation Quantity replaces Kind</li>
<li>Perturbation of the state</li>
</ul>
</div>
<div class="section" id="netcdf-restart-files">
<h2>NetCDF Restart Files<a class="headerlink" href="#netcdf-restart-files" title="Permalink to this headline">¶</a></h2>
<p>The programs filter and perfect_model_obs now read/write directly from
NetCDF files rather than having to run converters (<code class="docutils literal"><span class="pre">model_to_dart</span></code> and
<code class="docutils literal"><span class="pre">dart_to_model</span></code>). To facilitate this there is a new required call
<code class="docutils literal"><span class="pre">add_domain</span></code> which must be called during <code class="docutils literal"><span class="pre">static_init_model</span></code>. It can
be called multiple times in static_model_mod, e.g. once for each
NetCDF file that contains state variables. There are three ways to add a
domain:</p>
<ul class="simple">
<li><strong>From Blank</strong> : This is for small models such as lorenz_96 and no
NetCDF restarts<ul>
<li><code class="docutils literal"><span class="pre">dom_id</span> <span class="pre">=</span> <span class="pre">add_domain(model_size)</span></code></li>
</ul>
</li>
<li><strong>From File</strong> : This is for models which have NetCDF restart files<ul>
<li><code class="docutils literal"><span class="pre">dom_id</span> <span class="pre">=</span> <span class="pre">add_domain(template_file,</span> <span class="pre">num_vars,</span> <span class="pre">var_names,</span> <span class="pre">...</span> <span class="pre">)</span></code></li>
</ul>
</li>
<li><strong>From Spec</strong> : Creates a skeleton structure for a domain ( currently
only used in bgrid_solo )<ul>
<li><code class="docutils literal"><span class="pre">dom_id</span> <span class="pre">=</span> <span class="pre">add_domain(num_vars,</span> <span class="pre">var_names,</span> <span class="pre">...</span> <span class="pre">)</span></code>
<code class="docutils literal"><span class="pre">call</span> <span class="pre">add_dimension_to_variable(dom_id,</span> <span class="pre">var_id,</span> <span class="pre">dim_nam,</span> <span class="pre">dim_size)</span></code>
<code class="docutils literal"><span class="pre">call</span> <span class="pre">finished_adding_domain</span></code></li>
</ul>
</li>
</ul>
<p>For models without NetCDF restarts, use <code class="docutils literal"><span class="pre">add_domain(model_size)</span></code>. This
is the minimum amount of information needed by DART to create a netdcf
file. For models with NetCDF restarts use
<code class="docutils literal"><span class="pre">add_domain(info_file,</span> <span class="pre">num_vars,</span> <span class="pre">var_names)</span></code> which lets DART read the
NetCDF dimensions for a list of variables from a file (<code class="docutils literal"><span class="pre">info_file</span></code>).
There are several routines that can be used together to create a domain
from a description:
<code class="docutils literal"><span class="pre">add_domain,</span> <span class="pre">add_dimension_to_variable,</span> <span class="pre">finished_adding_domain</span></code>. This
can be used in models such as bgrid_solo where the model is spun up in
perfect_model_obs, but the model itself has variable structure (3D
variables with names). See <a class="reference external" href="#namelist_changes">Additions/Changes to existing namelists for
how to use NetCDF IO</a>.</p>
<p><strong>Note</strong> when using NetCDF restarts, inflation files are NetCDF also.
The inflation mean and inflation standard deviation are in separate
files when you use NetCDF restarts. See <a class="reference external" href="netcdf_inflation_files.html">NetCDF inflation
files</a> for details.</p>
</div>
<div class="section" id="calculation-of-forward-operators">
<h2>Calculation of Forward Operators<a class="headerlink" href="#calculation-of-forward-operators" title="Permalink to this headline">¶</a></h2>
<p>The forward operator code in model_mod now operates on an array of
state values. See <a class="reference external" href="forward_operator.html">forward operator</a> for more
detail about distributed vs. non-distributed forward operators. In
distributed mode the forward operators for all ensemble members are
calculated in the same <code class="docutils literal"><span class="pre">model_interpolate</span></code> call. In non-distributed
mode, the forward operators for all ensemble members a task owns
(1-ens_size) are calculated at once.</p>
</div>
<div class="section" id="vertical-conversion-of-observation-and-state-locations">
<h2>Vertical Conversion of Observation and State Locations<a class="headerlink" href="#vertical-conversion-of-observation-and-state-locations" title="Permalink to this headline">¶</a></h2>
<p>The vertical conversion of observation locations is done before the
assimilation by default. This can be changed by namelist options.</p>
<p>In Lanai this calculation is done in the assimilation as part of
<code class="docutils literal"><span class="pre">get_close_obs</span></code> if a model_mod does vertical conversion. See
<a class="reference external" href="vertical_conversion.html">vertical conversion</a> for details about
this change. Note that not all models do vertical conversion or even
have a concept of vertical location, but every model_mod must have the
following routines:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">call</span> <span class="n">set_vertical_localization_coord</span><span class="p">(</span><span class="n">vert_localization_coord</span><span class="p">)</span>

<span class="n">call</span> <span class="n">convert_vertical_obs</span><span class="p">(</span><span class="n">ens_handle</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">locs</span><span class="p">,</span> <span class="n">loc_qtys</span><span class="p">,</span> <span class="n">loc_types</span><span class="p">,</span> <span class="o">&amp;</span>
                          <span class="n">which_vert</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>

<span class="n">call</span> <span class="n">convert_vertical_state</span><span class="p">(</span><span class="n">ens_handle</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">locs</span><span class="p">,</span> <span class="n">loc_qtys</span><span class="p">,</span> <span class="n">loc_indx</span><span class="p">,</span> <span class="o">&amp;</span>
                            <span class="n">which_vert</span><span class="p">,</span> <span class="n">istatus</span><span class="p">)</span>
</pre></div>
</div>
<p>If there are NOT multiple choices for a vertical coordinate (e.g.
cartesian, one dimensional), all these routines can be no-ops.</p>
<p>If there are multiple types of vertical coordinates, the convert
routines must be able to convert between them. The
&#8216;set_vertical_localization_coord()&#8217; routine should be called from
&#8216;static_init_model()&#8217; to set what localization coordinate type is
being requested.</p>
<p>The three routines related to vertical coordinates/localization choices
are:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">set_vert_localization_coord</span></code> - sets the vertical localization
coordiate (not required if there is no vertical conversion)</li>
<li><code class="docutils literal"><span class="pre">convert_vertical_obs</span></code> - converts observation location to required
vertical type (does nothing if there is no vertical conversion)</li>
<li><code class="docutils literal"><span class="pre">convert_vertical_state</span></code> - converts state vector location to
required vertical type (does nothing if there is no vertical
conversion)</li>
</ul>
</div>
<div class="section" id="dart-diagnostic-file-changes">
<h2>DART Diagnostic file changes<a class="headerlink" href="#dart-diagnostic-file-changes" title="Permalink to this headline">¶</a></h2>
<p>For large models DART format diagnostic files (Prior_Diag.nc and
Posterior_Diag.nc) have been replaced with separate files for each copy
that would have gone into Prior_Diag.nc and Posterior_Diag.nc.</p>
<p>For Prior_Diag.nc:</p>
<ul class="simple">
<li><strong>Mean and standard deviation</strong>:
&nbsp;&nbsp;preassim_mean.nc
&nbsp;&nbsp;preassim_sd.nc</li>
<li><strong>Inflation mean and standard deviation</strong> (if state space inflation
is used):
&nbsp;&nbsp;preassim_priorinf_mean.nc
&nbsp;&nbsp;preassim_priorinf_sd.nc</li>
<li><strong>The number of ensemble members specifed</strong> in filter_nml
(num_output_state_members):
&nbsp;&nbsp;preassim_member_####.nc</li>
</ul>
<p>For Posterior_Diag.nc:</p>
<ul class="simple">
<li><strong>Mean and standard deviation</strong>:
&nbsp;&nbsp;postassim_mean.nc
&nbsp;&nbsp;postassim_sd.nc</li>
<li><strong>Inflation mean and standard deviation</strong> (if state space inflation
is used):
&nbsp;&nbsp;postassim_priorinf_mean.nc
&nbsp;&nbsp;postassim_priorinf_sd.nc</li>
<li><strong>The number of ensemble members specifed</strong> in filter_nml
(num_output_state_members):
&nbsp;&nbsp;postassim_member_####.nc</li>
</ul>
<p>The <code class="docutils literal"><span class="pre">num_output_state_members</span></code> are not written separately from the
restarts. Note that restarts will have been clamped if any clamping is
applied (given as an arguement to add_domain). This is <em>different</em> to
Posterior_Diag.nc which contains unclamped values. Note also that there
are 2 more <a class="reference external" href="#STAGES_TO_WRITE">&#8220;stages&#8221;</a> which might be output, in
addition to the preassim and postassim discussed here.</p>
<p>For models with multiple domains the filenames above are appended with
the domain number, e.g. preassim_mean.nc becomes
preassim_mean_d01.nc, preassim_mean_d02.nc, etc.</p>
<div class="section" id="changes-to-nc-write-model-atts">
<h3>Changes to nc_write_model_atts<a class="headerlink" href="#changes-to-nc-write-model-atts" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">nc_write_model_atts</span></code> now has 2 arguments:</p>
<ul class="simple">
<li>ncid - open netcdf file identifier</li>
<li>domain_id - domain number being written</li>
</ul>
<p>The calling code will write the model state, so this routine should only
add attributes and optionally, non-state information like grid arrays.</p>
<p>This routine will only be called if DART is creating an output NetCDF
file from scratch. This may include any of the preassim, postassim, or
output files.</p>
</div>
<div class="section" id="changes-to-nc-write-model-vars">
<h3>Changes to nc_write_model_vars<a class="headerlink" href="#changes-to-nc-write-model-vars" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">nc_write_model_vars</span></code> is currently unused (and in fact uncalled). It
remains for possible future expansion.</p>
</div>
</div>
<div class="section" id="model-mod-f90-interface-changes">
<h2>model_mod.f90 Interface Changes<a class="headerlink" href="#model-mod-f90-interface-changes" title="Permalink to this headline">¶</a></h2>
<p>The model_mod.f90 file contains all code that is specific to any
particular model. The code in this file is highly constrained since
these routines are *called by* other code in the DART system. All
routine interfaces &#8211; the names, number of arguments, and the names of
those arguments &#8211; must match the prescribed interfaces exactly. Since
not all required interfaces are needed for every model there are default
routines provided that can be referenced from a &#8216;use&#8217; statement and then
the routine name can be put in the module &#8216;public&#8217; list without any code
for that routine having to be written in the model_mod.f90 file.</p>
<p>The following 18 routines are required:</p>
<ul class="simple">
<li>static_init_model</li>
<li>get_model_size</li>
<li>get_state_meta_data</li>
<li>shortest_time_between_assimilations</li>
<li>model_interpolate</li>
<li>end_model</li>
<li>nc_write_model_atts</li>
<li>nc_write_model_vars</li>
<li>init_time</li>
<li>init_conditions</li>
<li>adv_1step</li>
<li>pert_model_copies</li>
<li>get_close_obs</li>
<li>get_close_state</li>
<li>convert_vertical_obs</li>
<li>convert_vertical_state</li>
<li>read_model_time</li>
<li>write_model_time</li>
</ul>
<p>Here is an example of code from the top of a model_mod file, including
the modules where the default routines live and the required public
list.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>use     location_mod, only : location_type, get_close_type, &amp;
                             get_close_obs, get_close_state, &amp;
                             convert_vertical_obs, convert_vertical_state, &amp;
                             set_location, set_location_missing, &amp;
                             set_vertical_localization_coord
use    utilities_mod, only : register_module, error_handler, &amp;
                             E_ERR, E_MSG
                             ! nmlfileunit, do_output, do_nml_file, do_nml_term,  &amp;
                             ! find_namelist_in_file, check_namelist_read
use netcdf_utilities_mod, only : nc_add_global_attribute, nc_synchronize_file, &amp;
                                 nc_add_global_creation_time, &amp;
                                 nc_begin_define_mode, nc_end_define_mode
use state_structure_mod, only : add_domain
use ensemble_manager_mod, only : ensemble_type
use dart_time_io_mod, only  : read_model_time, write_model_time
use default_model_mod, only : pert_model_copies, nc_write_model_vars

implicit none
private

! required by DART code - will be called from filter and other
! DART executables.  interfaces to these routines are fixed and
! cannot be changed in any way.
public :: static_init_model,      &amp;
          get_model_size,         &amp;
          get_state_meta_data,    &amp;
          shortest_time_between_assimilations, &amp;
          model_interpolate,      &amp;
          end_model,              &amp;
          nc_write_model_atts,    &amp;
          adv_1step,              &amp;
          init_time,              &amp;
          init_conditions

! public but in another module
public :: nc_write_model_vars,    &amp;
          pert_model_copies,      &amp;
          get_close_obs,          &amp;
          get_close_state,        &amp;
          convert_vertical_obs,   &amp;
          convert_vertical_state, &amp;
          read_model_time,        &amp;
          write_model_time
</pre></div>
</div>
</div>
<div class="section" id="observation-quantity-replaces-kinds">
<h2>Observation Quantity replaces Kinds<a class="headerlink" href="#observation-quantity-replaces-kinds" title="Permalink to this headline">¶</a></h2>
<p>Historically there has been confusion about the terms for specific
observation types (which often include the name of the instrument
collecting the data) and the generic quantity that is being measured
(e.g. temperature). The previous terms for these were &#8216;types&#8217; and
&#8216;kinds&#8217;, respectively.</p>
<p>Starting with the Manhattan release we have tried to clarify the
terminology and make the interfaces consistent. The following table
lists the original names from the Lanai/Classic release and the
replacement routines in Manhattan.</p>
<p>All code that is part of the DART code repository has been updated to
use the replacment routines, but if you have your own utilities written
using this code, you will need to update your code. Contact us
(<a class="reference external" href="mailto:dart&#37;&#52;&#48;ucar&#46;edu">dart<span>&#64;</span>ucar<span>&#46;</span>edu</a>) for help if you have any questions.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">public</span> <span class="n">subroutines</span><span class="p">,</span> <span class="n">existing</span> <span class="n">name</span> <span class="n">on</span> <span class="n">left</span><span class="p">,</span> <span class="n">replacement</span> <span class="n">on</span> <span class="n">right</span><span class="p">:</span>

<span class="n">assimilate_this_obs_kind</span><span class="p">()</span>     <span class="o">=&gt;</span>     <span class="n">assimilate_this_type_of_obs</span><span class="p">(</span><span class="n">type_index</span><span class="p">)</span>
<span class="n">evaluate_this_obs_kind</span><span class="p">()</span>       <span class="o">=&gt;</span>       <span class="n">evaluate_this_type_of_obs</span><span class="p">(</span><span class="n">type_index</span><span class="p">)</span>
<span class="n">use_ext_prior_this_obs_kind</span><span class="p">()</span>  <span class="o">=&gt;</span>  <span class="n">use_ext_prior_this_type_of_obs</span><span class="p">(</span><span class="n">type_index</span><span class="p">)</span>

<span class="n">get_num_obs_kinds</span><span class="p">()</span>      <span class="o">=&gt;</span>  <span class="n">get_num_types_of_obs</span><span class="p">()</span>
<span class="n">get_num_raw_obs_kinds</span><span class="p">()</span>  <span class="o">=&gt;</span>  <span class="n">get_num_quantities</span><span class="p">()</span>

<span class="n">get_obs_kind_index</span><span class="p">()</span>     <span class="o">=&gt;</span> <span class="n">get_index_for_type_of_obs</span><span class="p">(</span><span class="n">type_name</span><span class="p">)</span>
<span class="n">get_obs_kind_name</span><span class="p">()</span>      <span class="o">=&gt;</span> <span class="n">get_name_for_type_of_obs</span><span class="p">(</span><span class="n">type_index</span><span class="p">)</span>

<span class="n">get_raw_obs_kind_index</span><span class="p">()</span>  <span class="o">=&gt;</span>  <span class="n">get_index_for_quantity</span><span class="p">(</span><span class="n">quant_name</span><span class="p">)</span>
<span class="n">get_raw_obs_kind_name</span><span class="p">()</span>   <span class="o">=&gt;</span>  <span class="n">get_name_for_quantity</span><span class="p">(</span><span class="n">quant_index</span><span class="p">)</span>

<span class="n">get_obs_kind_var_type</span><span class="p">()</span>  <span class="o">=&gt;</span>  <span class="n">get_quantity_for_type_of_obs</span><span class="p">(</span><span class="n">type_index</span><span class="p">)</span>

<span class="n">get_obs_kind</span><span class="p">()</span>      <span class="o">=&gt;</span>  <span class="n">get_obs_def_type_of_obs</span><span class="p">(</span><span class="n">obs_def</span><span class="p">)</span>
<span class="n">set_obs_def_kind</span><span class="p">()</span>  <span class="o">=&gt;</span>  <span class="n">set_obs_def_type_of_obs</span><span class="p">(</span><span class="n">obs_def</span><span class="p">)</span>

<span class="n">get_kind_from_menu</span><span class="p">()</span>      <span class="o">=&gt;</span>  <span class="n">get_type_of_obs_from_menu</span><span class="p">()</span>

<span class="n">read_obs_kind</span><span class="p">()</span>     <span class="o">=&gt;</span>   <span class="n">read_type_of_obs_table</span><span class="p">(</span><span class="n">file_unit</span><span class="p">,</span> <span class="n">file_format</span><span class="p">)</span>
<span class="n">write_obs_kind</span><span class="p">()</span>    <span class="o">=&gt;</span>  <span class="n">write_type_of_obs_table</span><span class="p">(</span><span class="n">file_unit</span><span class="p">,</span> <span class="n">file_format</span><span class="p">)</span>

<span class="n">maps</span> <span class="n">obs_seq</span> <span class="n">nums</span> <span class="n">to</span> <span class="n">specific</span> <span class="nb">type</span> <span class="n">nums</span><span class="p">,</span> <span class="n">only</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">read_obs_seq</span><span class="p">:</span>
<span class="n">map_def_index</span><span class="p">()</span>  <span class="o">=&gt;</span> <span class="n">map_type_of_obs_table</span><span class="p">()</span>

<span class="n">removed</span><span class="o">.</span>  <span class="n">apparently</span> <span class="n">unused</span><span class="p">,</span> <span class="ow">and</span> <span class="n">simply</span> <span class="n">calls</span> <span class="n">get_obs_kind_name</span><span class="p">():</span>
<span class="n">get_obs_name</span><span class="p">()</span>

<span class="n">apparently</span> <span class="n">unused</span> <span class="n">anywhere</span><span class="p">,</span> <span class="n">removed</span><span class="p">:</span>
<span class="n">add_wind_names</span><span class="p">()</span>
<span class="n">do_obs_form_pair</span><span class="p">()</span>

<span class="n">public</span> <span class="n">integer</span> <span class="n">parameter</span> <span class="n">constants</span> <span class="ow">and</span> <span class="n">subroutine</span> <span class="n">formal</span> <span class="n">argument</span> <span class="n">names</span><span class="p">,</span>
<span class="n">old</span> <span class="n">on</span> <span class="n">left</span><span class="p">,</span> <span class="n">new</span> <span class="n">on</span> <span class="n">right</span><span class="p">:</span>

<span class="n">KIND_</span> <span class="o">=&gt;</span> <span class="n">QTY_</span>
<span class="n">kind</span> <span class="o">=&gt;</span> <span class="n">quantity</span>

<span class="n">TYPE_</span> <span class="o">=&gt;</span> <span class="n">TYPE_</span>
<span class="nb">type</span> <span class="o">=&gt;</span> <span class="n">type_of_obs</span>

<span class="n">integer</span> <span class="n">parameters</span><span class="p">:</span>
<span class="n">max_obs_generic</span>  <span class="o">=&gt;</span>  <span class="n">max_defined_quantities</span>  <span class="p">(</span><span class="ow">not</span> <span class="n">currently</span> <span class="n">public</span><span class="p">,</span> <span class="n">leave</span> <span class="n">private</span><span class="p">)</span>
<span class="n">max_obs_kinds</span>    <span class="o">=&gt;</span>  <span class="n">max_defined_types_of_obs</span>
</pre></div>
</div>
</div>
<div class="section" id="additions-changes-to-existing-namelists">
<h2>Additions/Changes to Existing Namelists<a class="headerlink" href="#additions-changes-to-existing-namelists" title="Permalink to this headline">¶</a></h2>
<p>These namelist options used to be in filter_nml, now they are in
quality_control_nml.</p>
<div class="namelist"><div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&amp;</span><span class="n">quality_control_nml</span>
   <span class="n">input_qc_threshold</span>          <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
   <span class="n">outlier_threshold</span>           <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
   <span class="n">enable_special_outlier_code</span> <span class="o">=</span> <span class="o">.</span><span class="n">false</span><span class="o">.</span>
<span class="o">/</span>
</pre></div>
</div>
</div><p>New namelist variables</p>
<div class="namelist"><div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&amp;</span><span class="n">filter_nml</span>
   <span class="n">single_file_in</span>               <span class="o">=</span> <span class="o">.</span><span class="n">false</span><span class="o">.</span><span class="p">,</span>
   <span class="n">single_file_out</span>              <span class="o">=</span> <span class="o">.</span><span class="n">false</span><span class="o">.</span><span class="p">,</span>

   <span class="n">input_state_file_list</span>        <span class="o">=</span> <span class="s1">&#39;null&#39;</span><span class="p">,</span>
   <span class="n">output_state_file_list</span>       <span class="o">=</span> <span class="s1">&#39;null&#39;</span><span class="p">,</span>
   <span class="n">input_state_files</span>            <span class="o">=</span> <span class="s1">&#39;null&#39;</span><span class="p">,</span>
   <span class="n">output_state_files</span>           <span class="o">=</span> <span class="s1">&#39;null&#39;</span><span class="p">,</span>

   <span class="n">stages_to_write</span>              <span class="o">=</span> <span class="s1">&#39;output&#39;</span>
   <span class="n">write_all_stages_at_end</span>      <span class="o">=</span> <span class="o">.</span><span class="n">false</span><span class="o">.</span>
   <span class="n">output_restarts</span>              <span class="o">=</span> <span class="o">.</span><span class="n">true</span><span class="o">.</span>
   <span class="n">output_mean</span>                  <span class="o">=</span> <span class="o">.</span><span class="n">true</span><span class="o">.</span>
   <span class="n">output_sd</span>                    <span class="o">=</span> <span class="o">.</span><span class="n">true</span><span class="o">.</span>

   <span class="n">perturb_from_single_instance</span> <span class="o">=</span> <span class="o">.</span><span class="n">false</span><span class="o">.</span><span class="p">,</span>
   <span class="n">perturbation_amplitude</span>       <span class="o">=</span> <span class="mf">0.2</span><span class="n">_r8</span><span class="p">,</span>

   <span class="n">distributed_state</span>            <span class="o">=</span> <span class="o">.</span><span class="n">true</span><span class="o">.</span>
<span class="o">/</span>
</pre></div>
</div>
</div><div class="line-block">
<div class="line"><br /></div>
</div>
<div><p>Item
Type
Description
single_file_in
logical
True means that all of the restart and inflation information is read
from a single NetCDF file. False means that you must specify an
input_state_file_list and DART will be expecting
input_{priorinf,postinf}_{mean,sd}.nc files for inflation.
single_file_out
logical
True means that all of the restart and inflation information is written
to a single NetCDF file. False means that you must specify a
output_state_files and DART will be output files specified in the
list. Inflation files will be written in the form
input_{priorinf,postinf}_{mean,sd}.nc.
input_state_files
character array
This is used for single file input for low order models. For multiple
domains you can specify a file for each domain. When specifying a list
single_file_in, single_file_out must be set to .true.
output_state_files
character array
This is used for single file input for low order models. For multiple
domains you can specify a file for each domain. When specifying a list
single_file_in, single_file_out must be set to .true.
input_state_file_list
character array
A list of files containing input model restarts. For multiple domains
you can specify a file for each domain. When specifying a list
single_file_in, single_file_out must be set to .false.
output_state_file_list
character array
A list of files containing output model restarts. For multiple domains
you can specify a file for each domain. When specifying a list
single_file_in, single_file_out must be set to .false.
stages_to_write
character array
Controls which stages to write. Currently there are four options:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">input</span></code> &#8211; writes input mean and sd only</li>
<li><code class="docutils literal"><span class="pre">preassim</span></code> &#8211; before assimilation, before prior inflation is
applied</li>
<li><code class="docutils literal"><span class="pre">postassim</span></code> &#8211; after assimilation, before posterior inflation is
applied</li>
<li><code class="docutils literal"><span class="pre">output</span></code> &#8211; final output for filter which includes clamping and
inflation</li>
</ul>
<p>write_all_stages_at_end
logical
True means output all stages at the end of filter. This is more memory
intensive but requires less time. For larger models IO begins to
dominate the overall cost of the assimilation, so writting all stages at
the end writes more files in parallel, reducing the IO time. Filenames
are defined in <code class="docutils literal"><span class="pre">output_state_files</span></code>.
output_restarts
logical
True means output a restart file(s). Filenames are defined in
<code class="docutils literal"><span class="pre">output_state_files</span></code>.
output_mean
logical
True means output a restart file which contains the ensemble mean for
the stages that have been turned on in <code class="docutils literal"><span class="pre">stages_to_write</span></code>. The file
name will have the stage with <em>_mean</em> appended.
output_sd
logical
True means output a restart file which contains the ensemble standard
deviation for the stages that have been turned on in
<code class="docutils literal"><span class="pre">stages_to_write</span></code>. The file name will have the stage with <em>_sd</em>
appended.
perturb_from_single_instance
logical
Read a single file and perturb this to create an ensemble
perturbation_amplitude
float
Perturbation amplitude
distribute_state
logical
True keeps the state distributed across all tasks throughout the entire
execution of filter.</p>
</div><p><strong>NetCDF reads and writes:</strong></p>
<p>For <strong>input</strong> file names:</p>
<ul>
<li><p class="first">give <a href="#id1"><span class="problematic" id="id2">``</span></a>input_state_file_list `` a file for each domain, each of which
contains a list of restart files. An example of an &#8216;input_list.txt&#8217;
might look something like :</p>
<div class="namelist"><div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">advance_temp1</span><span class="o">/</span><span class="n">wrfinput_d01</span>
<span class="n">advance_temp2</span><span class="o">/</span><span class="n">wrfinput_d01</span>
<span class="n">advance_temp3</span><span class="o">/</span><span class="n">wrfinput_d01</span>
<span class="n">advance_temp4</span><span class="o">/</span><span class="n">wrfinput_d01</span>
<span class="n">advance_temp5</span><span class="o">/</span><span class="n">wrfinput_d01</span>
<span class="o">....</span>
</pre></div>
</div>
</div></li>
<li><p class="first">if no <code class="docutils literal"><span class="pre">input_state_file_list</span></code> is provided then default filenames
will be used e.g. input_member_####.nc, input_priorinf_mean.nc,
input_priorinf_sd.nc</p>
</li>
</ul>
<p>For <strong>output</strong> file names:</p>
<ul>
<li><p class="first">give <code class="docutils literal"><span class="pre">output_state_file_list</span></code> a file for each domain, each of which
contains a list of restart files. An example of an &#8216;input_list.txt&#8217;
might for WRF might look something like :</p>
<div class="namelist"><div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">wrf_out_d01</span><span class="o">.</span><span class="mf">0001.</span><span class="n">nc</span>
<span class="n">wrf_out_d01</span><span class="o">.</span><span class="mf">0002.</span><span class="n">nc</span>
<span class="n">wrf_out_d01</span><span class="o">.</span><span class="mf">0003.</span><span class="n">nc</span>
<span class="n">wrf_out_d01</span><span class="o">.</span><span class="mf">0004.</span><span class="n">nc</span>
<span class="n">wrf_out_d01</span><span class="o">.</span><span class="mf">0005.</span><span class="n">nc</span>
<span class="o">....</span>
</pre></div>
</div>
</div><p>if you would like to simply like to overwrite your previous data
input_list.txt = output_list.txt</p>
</li>
<li><p class="first">if no <code class="docutils literal"><span class="pre">output_state_files</span></code> is provided then default filenames will
be used e.g. output_member_####.nc, output_priorinf_mean.nc,
output_priorinf_sd.nc</p>
</li>
</ul>
<p>For small models you may want to use <code class="docutils literal"><span class="pre">single_file_in</span></code>,
<code class="docutils literal"><span class="pre">single_file_out</span></code> which contains all copies needed to run filter.</p>
<div class="namelist"><div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&amp;</span><span class="n">state_vector_io_nml</span>
   <span class="n">buffer_state_io</span>          <span class="o">=</span> <span class="o">.</span><span class="n">false</span><span class="o">.</span><span class="p">,</span>
   <span class="n">single_precision_output</span>  <span class="o">=</span> <span class="o">.</span><span class="n">false</span><span class="o">.</span><span class="p">,</span>
<span class="o">/</span>
</pre></div>
</div>
</div><p>When <code class="docutils literal"><span class="pre">buffer_state_io</span></code> is <code class="docutils literal"><span class="pre">.false.</span></code> the entire state is read into
memory at once if .true. variables are read one at a time. If your model
can not fit into memory at once this must be set to <code class="docutils literal"><span class="pre">.true.</span></code> .</p>
<p><code class="docutils literal"><span class="pre">single_precision_output</span></code> allows you to run filter in double precision
but write NetCDF files in single presision</p>
<div class="namelist"><div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&amp;</span><span class="n">assim_tools_nml</span>
   <span class="n">distribute_mean</span>  <span class="o">=</span> <span class="o">.</span><span class="n">true</span><span class="o">.</span>
<span class="o">/</span>
</pre></div>
</div>
</div><p>In previous DART releases, each processor gets a copy of the mean (in
ens_mean_for_model). In RMA DART, the mean is distributed across all
processors. However, a user can choose to have a copy of the mean on
each processor by setting <code class="docutils literal"><span class="pre">distribute_mean</span> <span class="pre">=</span> <span class="pre">.false.</span></code> . Note that the
mean state is accessed through <code class="docutils literal"><span class="pre">get_state</span></code> whether distribute_mean is
<code class="docutils literal"><span class="pre">.true.</span></code> or <code class="docutils literal"><span class="pre">.false.</span></code></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&amp;</span><span class="n">filter_nml</span>
   <span class="n">input_qc_threshold</span>          <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
   <span class="n">outlier_threshold</span>           <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
   <span class="n">enable_special_outlier_code</span> <span class="o">=</span> <span class="o">.</span><span class="n">false</span><span class="o">.</span>
   <span class="n">start_from_restart</span>          <span class="o">=</span> <span class="o">.</span><span class="n">false</span><span class="o">.</span>
   <span class="n">output_inflation</span>            <span class="o">=</span> <span class="o">.</span><span class="n">true</span><span class="o">.</span>
   <span class="n">output_restart</span>              <span class="o">=</span> <span class="o">.</span><span class="n">true</span><span class="o">.</span>
   <span class="o">/</span>
</pre></div>
</div>
<p>NOTE : <code class="docutils literal"><span class="pre">output_restart</span></code> has been renamed to <code class="docutils literal"><span class="pre">output_restarts</span></code>.
<strong>``output_inflation`` is no longer supported</strong> and only writes
inflation files if <code class="docutils literal"><span class="pre">inf_flavor</span> <span class="pre">&gt;</span> <span class="pre">1</span></code></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&amp;</span><span class="n">ensemble_manager_nml</span>
   <span class="n">single_restart_file_out</span> <span class="o">=</span> <span class="o">.</span><span class="n">true</span><span class="o">.</span>
   <span class="n">perturbation_amplitude</span>  <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
   <span class="o">/</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&amp;</span><span class="n">assim_manager_nml</span>
   <span class="n">write_binary_restart_files</span> <span class="o">=</span> <span class="o">.</span><span class="n">true</span><span class="o">.</span><span class="p">,</span>
   <span class="n">netCDF_large_file_support</span>  <span class="o">=</span> <span class="o">.</span><span class="n">false</span><span class="o">.</span>
   <span class="o">/</span>
</pre></div>
</div>
</div>
<div class="section" id="perturbations">
<h2>Perturbations<a class="headerlink" href="#perturbations" title="Permalink to this headline">¶</a></h2>
<p>The option to perturb one ensemble member to produce an ensemble is in
filter_nml:<code class="docutils literal"><span class="pre">perturb_from_single_instance</span></code>. The model_mod interface
is now <code class="docutils literal"><span class="pre">pert_model_copies</span></code> not <code class="docutils literal"><span class="pre">pert_model_state</span></code>. Each task
perturbs every ensemble member for its own subsection of state. This is
more complicated than the Lanai routine <code class="docutils literal"><span class="pre">pert_model_state</span></code>, where a
whole state vector is available. If a model_mod does not provide a
perturb interface, filter will do the perturbing with an amplitude set
in filter_nml:perturbation_amplitude. Note the perturb namelist
options have been removed from ensemble_manager_nml</p>
<div class="top"><p>[<a class="reference external" href="#">top</a>]</p>
</div></div>
<hr class="docutils" />
<div class="section" id="terms-of-use">
<h2>Terms of Use<a class="headerlink" href="#terms-of-use" title="Permalink to this headline">¶</a></h2>
<p>DART software - Copyright UCAR. This open source software is provided by
UCAR, &#8220;as is&#8221;, without charge, subject to all terms of use at
<a class="reference external" href="http://www.image.ucar.edu/DAReS/DART/DART_download">http://www.image.ucar.edu/DAReS/DART/DART_download</a></p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="85%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Contact:</td>
<td>DART core group</td>
</tr>
<tr class="row-even"><td>Revision:</td>
<td>$Revision: 11299 $</td>
</tr>
<tr class="row-odd"><td>Source:</td>
<td>$URL: <a class="reference external" href="https://svn-dares-dart.cgd.ucar.edu/DART/branches/rma_trunk/documentation/documentation/html/rma.html">https://svn-dares-dart.cgd.ucar.edu/DART/branches/rma_trunk/documentation/documentation/html/rma.html</a> $</td>
</tr>
<tr class="row-even"><td>Change Date:</td>
<td>$Date: 2017-03-10 16:45:23 -0700 (Fri, 10 Mar 2017) $</td>
</tr>
<tr class="row-odd"><td>Change&nbsp;history:</td>
<td>try &#8220;svn&nbsp;log&#8221; or &#8220;svn&nbsp;diff&#8221;</td>
</tr>
</tbody>
</table>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, DART Team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'2.0.0',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: ''
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>