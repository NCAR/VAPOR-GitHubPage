

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Distributed State &mdash; DART 2.0.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> DART
          

          
          </a>

          
            
            
              <div class="version">
                2.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="Lanai_diffs_from_Kodiak.html">DART Lanai Differences from Kodiak Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="auto-doc.html">Fortran</a></li>
<li class="toctree-l1"><a class="reference internal" href="Process.html">Conversion process</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">DART</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Distributed State</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/docs/distributed_state.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="distributed-state">
<h1>Distributed State<a class="headerlink" href="#distributed-state" title="Permalink to this headline">¶</a></h1>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>&nbsp;</td>
<td><div class="first last line-block">
<div class="line">Jump to <a class="reference external" href="../index.html">DART Documentation Main
Index</a></div>
<div class="line">version information for this file:</div>
<div class="line">$Id$</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>The key part of RMA DART is having a state that is physically
distributed across processors. The location in memory of any part of the
state vector (which processor and where in memory on that processor) is
completely under the control of filter, not model_mod.</p>
<p>Implications of this:</p>
<ul class="simple">
<li>The model_mod never gets a whole state vector to use. So no whole
vector for a forward operator, and no whole vector for the mean.</li>
<li>The model_mod can not make any assumptions about the order of
elements in the state.
Currently, filter is ordering variables in the order they are listed
in add_domain and with the dimenion order of the netcdf file. This
is what is happening in most model_mod converters (model_to_dart,
dart_to_model). However CAM and bgrid_solo rearrange the state in
Lanai. These model_mods (and converters) have been changed to not
rearrage the state.</li>
</ul>
<p>So, how does the model_mod access the state without having the vector
and not knowing the state order? - state accessor routines.</p>
<div class="section" id="state-accessor-routines">
<h2>State Accessor Routines<a class="headerlink" href="#state-accessor-routines" title="Permalink to this headline">¶</a></h2>
<div class="section" id="getting-the-dart-index">
<h3>Getting the dart index<a class="headerlink" href="#getting-the-dart-index" title="Permalink to this headline">¶</a></h3>
<p>function get_dart_vector_index(i, j, k, dom_id, var_id)</p>
<p>get_dart_vector_index returns the dart index for a given i,j,k of a
variable. Note if the variable is 1D j and k are ignored. If a variable
is 2D k is ignored. Note only variables upto 3D are supported, but this
could be extended to support upto 7 dimensional variables (or whatever
fortran and netcdf will support).</p>
</div>
<div class="section" id="getting-the-state-at-a-given-dart-index">
<h3>Getting the state at a given dart index<a class="headerlink" href="#getting-the-state-at-a-given-dart-index" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">function</span> <span class="pre">x</span> <span class="pre">=</span> <span class="pre">get_state(index,</span> <span class="pre">state_handle)</span></code></p>
<p>get_state returns the state x at the given index. state_handle is a
derived type which conatins the state information. state_handle is
passed to the model_mod from above. get_state returns an array of
values (the whole ensemble at index) during model_mod and a single
value (the mean) during get_close_obs or vert_convert.</p>
<p>If you have an array of indices, for example a forward operator which is
located in different levels on different ensemble members you can use
get_state_array. An example of this is in CAM when an observation is
in pressure, the level an observation is in depends on the state and so
can vary across the ensemble.</p>
<p><code class="docutils literal"><span class="pre">subroutine</span> <span class="pre">get_state_array(x(:),</span> <span class="pre">index(:),</span> <span class="pre">state_handle)</span></code></p>
<p>The code inside get_state_array will do the minimum amount of
communication to get you the indices you need. For example if</p>
<p>&nbsp; index = [ 3 4 3 3 4 3]</p>
<p>get_state_array will only do 2 mpi communications and return</p>
<p>&nbsp; x = [state(3), state(4), state(3), state(3), state(4), state(3)]</p>
<p>A limited module diagram is shown below. A -&gt; B means A uses B:</p>
<p><img alt="image1" src="docs/./Graphs/window.gv.svg" /></p>
<p>Filter_mod and assim_tools_mod take care of making data available for
use with get_state. Note get_state will only return data during
<em>model_interpolate</em>, <em>get_close_obs</em>, or <em>vert_convert</em>. If you use
get_state outside these routines you will get and error.</p>
<p><strong>Compliation Notes</strong></p>
<p>The Remote Memory Access programming model we are using uses
mpi_windows. There are 2 ways to compile window mods for mpi and
non-mpi filter. This is taken care of automatically when you run
quickbuild.csh or an mkmf_* with -mpi or -nompi. However, if you use
mpi, there is a choice of mpi_window mods:</p>
<ul class="simple">
<li>cray_win_mod.f90</li>
<li>no_cray_win_mod.f90</li>
</ul>
<div class="line-block">
<div class="line">We have these two modules that you can swap in your path_names files
because the MPI 2 standard states:</div>
<div class="line">Implementors may restrict the use of RMA communication that is
synchronized by lock calls to windows in memory allocated by
MPI_ALLOC_MEM.</div>
<div class="line">MPI_ALLOC_MEM uses cray pointers, thus we have supplied a window
module that uses cray pointers. However, no_cray_win_mod.f90 is the
default since some versions of gfortran (4.9.0) do not support cray
pointers. These different modules will go away when we swap to MPI 3.</div>
</div>
<div class="top"><p>[<a class="reference external" href="#">top</a>]</p>
</div><hr class="docutils" />
<div class="section" id="terms-of-use">
<h4>Terms of Use<a class="headerlink" href="#terms-of-use" title="Permalink to this headline">¶</a></h4>
<p>DART software - Copyright UCAR. This open source software is provided by
UCAR, &#8220;as is&#8221;, without charge, subject to all terms of use at
<a class="reference external" href="http://www.image.ucar.edu/DAReS/DART/DART_download">http://www.image.ucar.edu/DAReS/DART/DART_download</a></p>
<table border="1" class="docutils">
<colgroup>
<col width="39%" />
<col width="61%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Contact:</td>
<td>DART core group</td>
</tr>
<tr class="row-even"><td>Revision:</td>
<td>$Revision$</td>
</tr>
<tr class="row-odd"><td>Source:</td>
<td>$URL$</td>
</tr>
<tr class="row-even"><td>Change Date:</td>
<td>$Date$</td>
</tr>
<tr class="row-odd"><td>Change&nbsp;history:</td>
<td>try &#8220;svn&nbsp;log&#8221; or &#8220;svn&nbsp;diff&#8221;</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, DART Team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'2.0.0',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: ''
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>